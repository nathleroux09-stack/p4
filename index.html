<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 Matchmaking</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
/* ---------- TYPOGRAPHIE GLOBALE ---------- */
:root{
  --bg:#071128; --card:#0e2436; --muted:#9fb7c7; --text:#e8f3fb; --accent:#2ea44f; --accent-strong:#26a14a;
  --ghost:#133147; --danger:#e06a4a; --glass: rgba(255,255,255,0.04); --board-hole:#0b3a57; --hole-edge:#163a54;
  --disc-shadow: rgba(0,0,0,0.45);
}
*{box-sizing:border-box} html,body{height:100%;}
body {margin:0; padding:0.9rem; font-family:-apple-system,"Inter","Segoe UI",Roboto,sans-serif; background: linear-gradient(180deg,var(--bg) 0%, #052033 100%); color:var(--text); display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:0.8rem; min-height:100vh;}
h1{margin:0.6rem 0 0;font-size:1.15rem;font-weight:700;color:var(--text);letter-spacing:0.2px;text-align:center;width:100%;max-width:420px;text-shadow:0 1px 0 rgba(0,0,0,0.45);padding:8px 0;}
#loginContainer,#controls,#rematchContainer,#clocks,#playerInfo{width:100%;max-width:420px;display:flex;flex-direction:column;gap:0.45rem;align-items:stretch;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));padding:0.7rem;border-radius:12px;border: 1px solid rgba(255,255,255,0.04);box-shadow:0 6px 18px rgba(2,6,12,0.55), inset 0 1px 0 rgba(255,255,255,0.02);}
input[type="text"], input[type="password"], textarea {width:100%; min-height:44px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));color:var(--text);font-size:0.95rem;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);resize:vertical;transition: box-shadow .12s ease, border-color .12s ease, transform .06s ease;}
input::placeholder,textarea::placeholder{color: rgba(255,255,255,0.35); font-weight:500;}
input:focus,textarea:focus{border-color: rgba(46,164,79,0.9); box-shadow:0 6px 18px rgba(46,164,79,0.06), inset 0 1px 0 rgba(255,255,255,0.02); transform: translateY(-1px);}
textarea#codeField{min-height:92px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace;font-size:0.88rem;}
button{display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:44px;padding:10px 14px;border-radius:12px;border:none;background:var(--ghost);color:var(--text);font-weight:700;font-size:0.95rem;cursor:pointer;transition: transform .08s ease, box-shadow .12s ease, background .12s ease;box-shadow:0 6px 14px rgba(2,6,12,0.5);}
button:hover{transform:translateY(-2px);} button:active{transform:translateY(0);box-shadow:0 4px 8px rgba(0,0,0,0.5);}
button:disabled{opacity:0.45;cursor:not-allowed;transform:none;box-shadow:none;}
#loginContainer > button,#controls > button{width:100%;}
#status,#loginStatus,#rematchStatus{color:var(--muted);font-weight:600;font-size:0.9rem;padding:6px 8px;border-radius:8px;background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.02);}
#playerInfo{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:8px;background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));}
#playerInfo > div{display:flex;flex-direction:column;gap:4px;font-size:0.95rem;color:var(--text);}
#playerInfo span{ font-weight:800; color:#fff;font-size:0.95rem;}
#clocks{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.03);font-weight:800;font-size:0.95rem;}
#board{width:100%;max-width:420px;aspect-ratio:7/6;display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:repeat(6,1fr);gap:8px;padding:14px;border-radius:16px;background: linear-gradient(180deg, var(--board-hole), #082a3d);box-shadow:0 18px 40px rgba(1,8,15,0.7), inset 0 2px 10px rgba(255,255,255,0.02);touch-action:manipulation;}
.cell{width:100%;height:100%;aspect-ratio:1/1;border-radius:50%;display:flex;align-items:center;justify-content:center;background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.03), transparent 20%), linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));box-shadow: inset 0 -6px 12px rgba(0,0,0,0.6), inset 0 2px 6px rgba(255,255,255,0.02);cursor:pointer;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.02);}
.cell:active{transform:translateY(1px) scale(0.997);}
.disc{width:86%;height:86%;border-radius:50%;background:#111;box-shadow:0 6px 14px var(--disc-shadow), inset 0 2px 8px rgba(255,255,255,0.03);transition:transform .28s cubic-bezier(.2,.9,.3,1),background .2s ease,box-shadow .12s ease;display:block;z-index:1;}
.cell::after{content:"";position:absolute;inset:10% 10%;border-radius:50%;background: radial-gradient(circle at 35% 30%, rgba(255,255,255,0.02), rgba(0,0,0,0.3));z-index:0;pointer-events:none;}
.disc.red{background:linear-gradient(180deg,#ff5b5b,#c43b3b);box-shadow:0 8px 18px rgba(196,59,59,0.28), inset 0 2px 8px rgba(255,255,255,0.06);}
.disc.yellow{background:linear-gradient(180deg,#ffd35b,#d6a42c);box-shadow:0 8px 18px rgba(214,164,44,0.22), inset 0 2px 8px rgba(255,255,255,0.06);}
@keyframes dropIn{from{transform:translateY(-40%) scale(.98);opacity:0.85;} to{transform:translateY(0) scale(1);opacity:1;}}
.disc.dropped{animation:dropIn .26s cubic-bezier(.2,.9,.3,1) both;}
#rematchContainer{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border-radius:12px;}
@media(max-width:420px){#board{padding:10px;gap:6px;border-radius:12px;}}
@media(max-width:360px){body{padding:0.6rem;}h1{font-size:1rem;}#loginContainer,#controls,#board{padding:8px;border-radius:10px;}input,button{min-height:40px;font-size:0.92rem;}}
input:focus,textarea:focus,button:focus{outline:3px solid rgba(46,164,79,0.18);outline-offset:2px;border-radius:10px;}
</style>
</head>
<body>
<h1>Puissance 4 Matchmaking</h1>

<div id="loginContainer">
  <input type="text" id="usernameInput" placeholder="Pseudo">
  <input type="password" id="passwordInput" placeholder="Mot de passe">
  <button id="createAccountBtn">Créer un compte</button>
  <button id="loginBtn">Se connecter</button>
  <div id="loginStatus"></div>
</div>

<div id="playerInfo" style="display:none;">
  <div>
    Joueur : <span id="playerName"></span>
  </div>
  <div>
    Elo : <span id="myElo"></span>
  </div>
</div>

<div id="clocks" style="display:none;">
  <div>Vous : <span id="myClock">05:00</span></div>
  <div>Adversaire : <span id="opponentClock">05:00</span></div>
</div>

<div id="status" style="display:none;">En attente d'adversaire...</div>

<div id="board" style="display:none;"></div>

<div id="rematchContainer" style="display:none;">
  <button id="requestRematchBtn">Demander revanche</button>
  <div id="rematchStatus"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
// ---------------- SUPABASE INIT ----------------
const SUPABASE_URL = "https://arqyrmvnenrtxqryihnz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycXlybXZuZW5ydHhxcnlpaG56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTE1NjUsImV4cCI6MjA3NzMyNzU2NX0.fGs08ElwvYY2JOnWmq4sveYEa2Dg7g0BsdmRrkRM4xc";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ---------------- VARIABLES ----------------
let currentUser = null;
let currentGame = null;
let board = Array(6).fill(null).map(()=>Array(7).fill(null));
let myTurn = false;
let timerMy = 300;       // 5 minutes
let timerOpponent = 300;
let timerInterval = null;

// ---------------- UTILITIES ----------------
function formatTime(seconds){
  let m = Math.floor(seconds/60).toString().padStart(2,'0');
  let s = (seconds%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

// ---------------- LOGIN / CREATE ----------------
document.getElementById("createAccountBtn").onclick = async ()=>{
  const username = document.getElementById("usernameInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  if(!username || !password) return alert("Pseudo et mot de passe requis");
  const {data, error} = await supabase.from('users').insert([{username, password}]);
  if(error) document.getElementById("loginStatus").textContent = error.message;
  else document.getElementById("loginStatus").textContent = "Compte créé ! Connectez-vous.";
}

document.getElementById("loginBtn").onclick = async ()=>{
  const username = document.getElementById("usernameInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  if(!username || !password) return alert("Pseudo et mot de passe requis");
  const {data, error} = await supabase.from('users').select().eq('username', username).eq('password', password).single();
  if(error) { document.getElementById("loginStatus").textContent = "Échec connexion"; return;}
  currentUser = data;
  document.getElementById("loginContainer").style.display = "none";
  document.getElementById("playerInfo").style.display = "flex";
  document.getElementById("status").style.display = "block";
  document.getElementById("clocks").style.display = "flex";
  document.getElementById("playerName").textContent = currentUser.username;
  document.getElementById("myElo").textContent = currentUser.elo ?? 1000;
  startMatchmaking();
}

// ---------------- MATCHMAKING ----------------
async function startMatchmaking(){
  document.getElementById("status").textContent = "Recherche d'un adversaire...";
  
  // Cherche une partie en attente
  let {data: waitingGames, error} = await supabase
    .from('games')
    .select()
    .eq('status','waiting')
    .neq('player1', currentUser.username)
    .limit(1);
  
  if(waitingGames && waitingGames.length > 0){
    // Rejoindre le jeu
    const game = waitingGames[0];
    await supabase.from('games').update({
      player2: currentUser.username,
      p2_elo: currentUser.elo ?? 1000,
      status: 'playing'
    }).eq('id', game.id);
    currentGame = game;
    currentGame.player2 = currentUser.username;
    currentGame.p2_elo = currentUser.elo ?? 1000;
    myTurn = false;
    initBoard();
  } else {
    // Créer une nouvelle partie
    const {data:newGame,error:err} = await supabase.from('games').insert([{
      player1: currentUser.username,
      p1_elo: currentUser.elo ?? 1000,
      status:'waiting',
      boardState: JSON.stringify(board)
    }]).select().single();
    currentGame = newGame;
    myTurn = true;
    initBoard();
    waitForOpponent();
  }
}

// ---------------- WAIT FOR OPPONENT ----------------
function waitForOpponent(){
  const interval = setInterval(async ()=>{
    const {data: game} = await supabase.from('games').select().eq('id', currentGame.id).single();
    if(game.status === 'playing' && game.player2){
      currentGame = game;
      myTurn = false;
      clearInterval(interval);
      document.getElementById("status").textContent = "Adversaire trouvé ! À vous de jouer";
    }
  },1000);
}

// ---------------- INIT BOARD ----------------
function initBoard(){
  const boardDiv = document.getElementById("board");
  boardDiv.innerHTML = '';
  boardDiv.style.display = "grid";
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.row = r;
      cell.dataset.col = c;
      const disc = document.createElement("div");
      disc.classList.add("disc");
      cell.appendChild(disc);
      cell.onclick = ()=>makeMove(c);
      boardDiv.appendChild(cell);
    }
  }
  updateBoardUI();
  startClocks();
}

// ---------------- UPDATE BOARD ----------------
function updateBoardUI(){
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      const idx = r*7 + c;
      const disc = document.getElementById("board").children[idx].firstChild;
      disc.classList.remove("red","yellow","dropped");
      if(board[r][c]){
        disc.classList.add(board[r][c],"dropped");
      }
    }
  }
}

// ---------------- MAKE MOVE ----------------
async function makeMove(col){
  if(!myTurn) return;
  let row = -1;
  for(let r=5;r>=0;r--){
    if(!board[r][col]){ row = r; break; }
  }
  if(row===-1) return;
  board[row][col] = currentUser.username === currentGame.player1 ? 'red' : 'yellow';
  updateBoardUI();
  myTurn = false;
  await supabase.from('games').update({
    boardState: JSON.stringify(board),
    last_move: col,
    last_player: currentUser.username
  }).eq('id', currentGame.id);
  checkWin();
  waitForOpponentMove();
}

// ---------------- WAIT FOR OPPONENT MOVE ----------------
function waitForOpponentMove(){
  const interval = setInterval(async ()=>{
    const {data: game} = await supabase.from('games').select().eq('id', currentGame.id).single();
    const boardData = JSON.parse(game.boardState);
    if(JSON.stringify(boardData) !== JSON.stringify(board)){
      board = boardData;
      myTurn = true;
      updateBoardUI();
      clearInterval(interval);
      checkWin();
    }
  },1000);
}

// ---------------- CHECK WIN ----------------
function checkWin(){
  // Simple vérification horizontale/verticale/diag
  const directions = [[0,1],[1,0],[1,1],[1,-1]];
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      const player = board[r][c];
      if(!player) continue;
      for(const [dr,dc] of directions){
        let count=1;
        for(let i=1;i<4;i++){
          const nr=r+i*dr, nc=c+i*dc;
          if(nr<0||nr>5||nc<0||nc>6) break;
          if(board[nr][nc]===player) count++;
        }
        if(count>=4){
          alert(`${player==="red"?currentGame.player1:currentGame.player2} a gagné !`);
          document.getElementById("rematchContainer").style.display="flex";
          return;
        }
      }
    }
  }
}

// ---------------- CLOCKS ----------------
function startClocks(){
  clearInterval(timerInterval);
  document.getElementById("myClock").textContent = formatTime(timerMy);
  document.getElementById("opponentClock").textContent = formatTime(timerOpponent);
  timerInterval = setInterval(()=>{
    if(myTurn){ timerMy--; if(timerMy<=0){ alert("Temps écoulé !"); clearInterval(timerInterval); } }
    else { timerOpponent--; if(timerOpponent<=0){ alert("Adversaire a perdu au temps !"); clearInterval(timerInterval); } }
    document.getElementById("myClock").textContent = formatTime(timerMy);
    document.getElementById("opponentClock").textContent = formatTime(timerOpponent);
  },1000);
}

// ---------------- REMATCH ----------------
document.getElementById("requestRematchBtn").onclick = async ()=>{
  if(!currentGame) return;
  await supabase.from('games').update({
    status:'waiting',
    boardState: JSON.stringify(Array(6).fill(null).map(()=>Array(7).fill(null))),
    last_move:null,
    last_player:null
  }).eq('id',currentGame.id);
  board = Array(6).fill(null).map(()=>Array(7).fill(null));
  updateBoardUI();
  myTurn = true;
  document.getElementById("rematchContainer").style.display="none";
  document.getElementById("status").textContent="Recherche d'adversaire...";
  startMatchmaking();
}
</script>
</body>
</html>