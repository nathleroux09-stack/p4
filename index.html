<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 Matchmaking</title>
<style>
:root{
  --bg:#071128; --card:#0e2436; --muted:#9fb7c7; --text:#e8f3fb;
  --accent:#2ea44f; --accent-strong:#26a14a; --ghost:#133147; --danger:#e06a4a;
  --board-hole:#0b3a57; --hole-edge:#163a54; --disc-shadow: rgba(0,0,0,0.45);
}
*{box-sizing:border-box}
html,body{height:100%;}
body{margin:0;padding:0.9rem;font-family:-apple-system, "Inter", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
background:linear-gradient(180deg,var(--bg) 0%, #052033 100%); color:var(--text);
display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:0.8rem;min-height:100vh;}
h1{margin:0.6rem 0 0;font-size:1.15rem;font-weight:700;color:var(--text);letter-spacing:0.2px;text-align:center;width:100%;max-width:420px;text-shadow:0 1px 0 rgba(0,0,0,0.45);padding:8px 0;}
#loginContainer, #controls, #rematchContainer, #clocks, #playerInfo{width:100%;max-width:420px;display:flex;flex-direction:column;gap:0.45rem;align-items:stretch;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));padding:0.7rem;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 18px rgba(2,6,12,0.55), inset 0 1px 0 rgba(255,255,255,0.02);}
input[type="text"], input[type="password"], textarea{width:100%;min-height:44px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));color:var(--text);font-size:0.95rem;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);resize: vertical;transition: box-shadow .12s ease, border-color .12s ease, transform .06s ease;}
input::placeholder{color: rgba(255,255,255,0.35); font-weight:500;}
input:focus, textarea:focus{border-color: rgba(46,164,79,0.9);box-shadow:0 6px 18px rgba(46,164,79,0.06), inset 0 1px 0 rgba(255,255,255,0.02);transform: translateY(-1px);}
button{display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:44px;padding:10px 14px;border-radius:12px;border:none;background:var(--ghost);color:var(--text);font-weight:700;font-size:0.95rem;cursor:pointer;transition: transform .08s ease, box-shadow .12s ease, background .12s ease;box-shadow:0 6px 14px rgba(2,6,12,0.5);}
#loginContainer button#loginBtn,#loginContainer button#createAccountBtn,#controls button#joinMatch,#rematchContainer button#rematchBtn{background:linear-gradient(180deg, var(--accent), var(--accent-strong)); color:#fff; box-shadow:0 8px 22px rgba(38,161,74,0.18);}
button:hover{ transform: translateY(-2px); } button:active{ transform: translateY(0); box-shadow:0 4px 8px rgba(0,0,0,0.5); } button:disabled{opacity:0.45;cursor:not-allowed;transform:none;box-shadow:none;}
#status,#loginStatus,#rematchStatus{color:var(--muted);font-weight:600;font-size:0.9rem;padding:6px 8px;border-radius:8px;background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.02);}
#playerInfo{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:8px;background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));}
#playerInfo > div{display:flex;flex-direction:column;gap:4px;font-size:0.95rem;color:var(--text);}
#playerInfo span{ font-weight:800;color:#fff;font-size:0.95rem;}
#clocks{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.03);font-weight:800;font-size:0.95rem;}
#board{width:100%;max-width:420px;aspect-ratio:7/6;display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:repeat(6,1fr);gap:8px;padding:14px;border-radius:16px;background:linear-gradient(180deg,var(--board-hole),#082a3d);box-shadow:0 18px 40px rgba(1,8,15,0.7), inset 0 2px 10px rgba(255,255,255,0.02);touch-action:manipulation;}
.cell{width:100%;height:100%;aspect-ratio:1/1;border-radius:50%;display:flex;align-items:center;justify-content:center;background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.03), transparent 20%), linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));box-shadow: inset 0 -6px 12px rgba(0,0,0,0.6), inset 0 2px 6px rgba(255,255,255,0.02);cursor:pointer;transition: transform .08s ease;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.02);}
.cell:active{transform: translateY(1px) scale(.997);}
.disc{width:86%;height:86%;border-radius:50%;background:#111;box-shadow:0 6px 14px var(--disc-shadow), inset 0 2px 8px rgba(255,255,255,0.03);transition: transform .28s cubic-bezier(.2,.9,.3,1), background .2s ease, box-shadow .12s ease;display:block;z-index:1;}
.cell::after{content:"";position:absolute;inset:10% 10%;border-radius:50%;background: radial-gradient(circle at 35% 30%, rgba(255,255,255,0.02), rgba(0,0,0,0.3));z-index:0;pointer-events:none;}
.disc.red{background: linear-gradient(180deg,#ff5b5b,#c43b3b);box-shadow:0 8px 18px rgba(196,59,59,0.28), inset 0 2px 8px rgba(255,255,255,0.06);}
.disc.yellow{background: linear-gradient(180deg,#ffd35b,#d6a42c);box-shadow:0 8px 18px rgba(214,164,44,0.22), inset 0 2px 8px rgba(255,255,255,0.06);}
@keyframes dropIn{from{transform:translateY(-40%) scale(.98);opacity:0.85;}to{transform:translateY(0) scale(1);opacity:1;}}
.disc.dropped{animation: dropIn .26s cubic-bezier(.2,.9,.3,1) both;}
#rematchContainer{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border-radius:12px;}
</style>
</head>
<body>
<h1>Puissance 4 Matchmaking</h1>
<div id="loginContainer">
  <input type="text" id="usernameInput" placeholder="Pseudo">
  <input type="password" id="passwordInput" placeholder="Mot de passe">
  <button id="createAccountBtn">Cr√©er un compte</button>
  <button id="loginBtn">Se connecter</button>
  <div id="loginStatus"></div>
</div>
<div id="playerInfo" style="display:none;">
  <div id="myEloContainer">Elo : <span id="myElo"></span></div>
</div>
<div id="controls" style="display:none;">
  <button id="joinMatch">Chercher adversaire</button>
  <div id="status">Statut : D√©connect√©</div>
</div>
<div id="clocks" style="display:none;">
  <div id="myClockContainer"><span id="myPseudo"></span> (<span id="myEloClock"></span>) : <span id="myClock">05:00</span></div>
  <div id="opClockContainer"><span id="opPseudo"></span> (<span id="opEloClock"></span>) : <span id="opClock">05:00</span></div>
</div>
<div id="board"></div>
<div id="rematchContainer">
  <button id="rematchBtn">Revanche</button>
  <button id="declineBtn">‚úñ</button>
  <span id="rematchStatus"></span>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const SUPABASE_URL = 'https://arqyrmvnenrtxqryihnz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycXlybXZuZW5ydHhxcnlpaG56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTE1NjUsImV4cCI6MjA3NzMyNzU2NX0.fGs08ElwvYY2JOnWmq4sveYEa2Dg7g0BsdmRrkRM4xc';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const el=id=>document.getElementById(id);

let board=Array(6).fill().map(()=>Array(7).fill(''));
let turn=null, myColor=null, opponentColor=null, gameOver=false;
let myTime=300, opTime=300, myInterval=null, opInterval=null;
let currentUser=null, currentMatch=null;

// ------------------ BOARD ------------------
function createBoard(){
  const boardDiv = el('board'); boardDiv.innerHTML='';
  for(let r=0;r<6;r++){for(let c=0;c<7;c++){
    const cell=document.createElement('div'); cell.className='cell'; cell.dataset.col=c;
    const disc=document.createElement('div'); disc.className='disc'; cell.appendChild(disc);
    cell.onclick=()=>handleColumnClick(c);
    boardDiv.appendChild(cell);
  }}
}
createBoard();

function updateBoard(){
  const discs=document.querySelectorAll('.disc');
  for(let r=0;r<6;r++){for(let c=0;c<7;c++){
    if(board[r][c]==='red') discs[r*7+c].className='disc red dropped';
    else if(board[r][c]==='yellow') discs[r*7+c].className='disc yellow dropped';
    else discs[r*7+c].className='disc';
  }}
}

async function dropDisc(col,color){
  for(let r=5;r>=0;r--){
    if(!board[r][col]){
      board[r][col]=color; updateBoard();
      if(checkWin(r,col,color)) {
        endGame(`${color} gagne !`, color);
        await supabase.from('matches').update({
          boardstate: JSON.stringify(board),
          status: 'finished',
          winner: color
        }).eq('id', currentMatch.id);
      }
      return true;
    }
  }
  return false;
}

function checkWin(row,col,color){
  const dirs=[[1,0],[0,1],[1,1],[1,-1]];
  const countDir=(dr,dc)=>{
    let r=row+dr, c=col+dc, cnt=0;
    while(r>=0&&r<6&&c>=0&&c<7&&board[r][c]===color){cnt++; r+=dr; c+=dc;}
    return cnt;
  }
  for(const [dr,dc] of dirs){if(1+countDir(dr,dc)+countDir(-dr,-dc)>=4) return true;}
  return false;
}

// ---------- LOGIN / CREATE ----------
el('createAccountBtn').onclick=async()=>{
  const username=el('usernameInput').value.trim(), password=el('passwordInput').value.trim();
  if(!username||!password){el('loginStatus').textContent="Pseudo et mdp requis"; return;}
  const {data,error}=await supabase.from('profiles').insert([{username,password,elo:1000}]);
  if(error){el('loginStatus').textContent="Erreur cr√©ation compte: "+error.message; return;}
  el('loginStatus').textContent="Compte cr√©√©, connecte-toi";
};

el('loginBtn').onclick=async()=>{
  const username=el('usernameInput').value.trim(), password=el('passwordInput').value.trim();
  if(!username||!password){el('loginStatus').textContent="Pseudo et mdp requis"; return;}
  const {data,error}=await supabase.from('profiles').select('*').eq('username',username).eq('password',password).single();
  if(error||!data){el('loginStatus').textContent="Pseudo ou mdp incorrect"; return;}
  currentUser={username:data.username, elo:parseInt(data.elo)};
  el('myElo').textContent=currentUser.elo;
  el('loginContainer').style.display='none';
  el('controls').style.display='flex';
  el('playerInfo').style.display='flex';
  el('myPseudo').textContent=currentUser.username;
  el('myEloClock').textContent=currentUser.elo;
};

// ------------------ MATCHMAKING ------------------
el('joinMatch').onclick = async () => {
    el('status').textContent = "Statut : Recherche adversaire...";
    const { data: waitingMatch } = await supabase
        .from('matches')
        .select('*')
        .eq('status', 'waiting')
        .neq('player1', currentUser.username)
        .limit(1)
        .single();

    if (waitingMatch) {
        currentMatch = waitingMatch;
        await supabase.from('matches').update({
            player2: currentUser.username,
            p2_elo: currentUser.elo,
            turn: 'red',
            status: 'playing',
            boardstate: JSON.stringify(board)
        }).eq('id', currentMatch.id);
        myColor = 'yellow';
        opponentColor = 'red';
    } else {
        const { data: newMatch, error } = await supabase.from('matches').insert([{
            player1: currentUser.username,
            p1_elo: currentUser.elo,
            status: 'waiting',
            boardstate: JSON.stringify(board),
            turn: 'red'
        }]).select().single();
        if (error) {
            el('status').textContent = "Statut : Erreur cr√©ation match";
            return;
        }
        currentMatch = newMatch;
        myColor = 'red';
        opponentColor = 'yellow';
    }

    el('controls').style.display = 'none';
    el('clocks').style.display = 'flex';
    el('status').textContent = "Statut : Match trouv√© !";
    startListeningMatch();
    updateClocks();
};

// ------------------ SUPABASE SUBSCRIPTION ------------------
function startListeningMatch() {
    supabase
        .channel('realtime-matches')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'matches', filter: `id=eq.${currentMatch.id}` }, payload => {
            const updated = payload.new;
            board = JSON.parse(updated.boardstate);
            turn = updated.turn;

            // Actualise les infos de l'adversaire si dispo
            if (updated.player1 && updated.player2) {
                currentMatch.player1 = updated.player1;
                currentMatch.player2 = updated.player2;
                currentMatch.p1_elo = updated.p1_elo;
                currentMatch.p2_elo = updated.p2_elo;
            }

            updateBoard();
            updateClocks();

// üß© --- Fin de partie partag√©e + Synchronisation Supabase ---

function endGame(message, winnerColor) {
    gameOver = true;
    clearInterval(myInterval);
    clearInterval(opInterval);

    el("status").textContent = message;
    el("status").style.color = winnerColor === "red" ? "red" : "gold";

    // Enregistrer la fin de la partie dans Supabase
    if (currentMatch && currentMatch.id) {
        supabase.from("matches").update({
            boardstate: JSON.stringify(board),
            status: "finished",
            winner: winnerColor,
        }).eq("id", currentMatch.id);
    }
}

// üß© --- Fonction pour √©couter les mises √† jour du match en temps r√©el ---
function startListeningMatch() {
    supabase
        .channel("realtime-matches")
        .on("postgres_changes", {
            event: "*",
            schema: "public",
            table: "matches",
            filter: `id=eq.${currentMatch.id}`
        }, payload => {
            const updated = payload.new;
            if (!updated) return;

            // Actualisation des donn√©es du match
            if (updated.player1 && updated.player2) {
                currentMatch.player1 = updated.player1;
                currentMatch.player2 = updated.player2;
                currentMatch.p1_elo = updated.p1_elo;
                currentMatch.p2_elo = updated.p2_elo;
            }

            // Actualisation du plateau
            if (updated.boardstate) {
                board = JSON.parse(updated.boardstate);
                updateBoard();
            }

            // Actualisation du tour
            if (updated.turn) {
                turn = updated.turn;
                updateClocks();
            }

            // Si la partie est termin√©e, afficher le r√©sultat sur les deux √©crans
            if (updated.status === "finished" && !gameOver) {
                gameOver = true;
                clearInterval(myInterval);
                clearInterval(opInterval);

                el("status").textContent = `Partie termin√©e : ${updated.winner === "red" ? "üî¥ Rouge" : "üü° Jaune"} gagne !`;
                el("status").style.color = updated.winner === "red" ? "red" : "gold";
            }
        })
        .subscribe();
}

// üß© --- Gestion du clic sur le plateau ---
async function handleColumnClick(col) {
    if (gameOver) return;

    const color = currentColor;
    if (turn !== color) return; // ce n‚Äôest pas ton tour

    const row = getLowestEmptyRow(col);
    if (row === -1) return;

    board[row][col] = color;
    updateBoard();

    // V√©rifie victoire
    if (checkWin(row, col, color)) {
        endGame(`${color === "red" ? "üî¥ Rouge" : "üü° Jaune"} gagne !`, color);
        await supabase.from("matches").update({
            boardstate: JSON.stringify(board),
            turn: color,
            status: "finished",
            winner: color
        }).eq("id", currentMatch.id);
        return;
    }

    // Sinon, passe le tour
    turn = color === "red" ? "yellow" : "red";
    await supabase.from("matches").update({
        boardstate: JSON.stringify(board),
        turn: turn
    }).eq("id", currentMatch.id);
}

// üß© --- V√©rification de victoire ---
function checkWin(row, col, color) {
    const dirs = [
        [0, 1], [1, 0], [1, 1], [1, -1]
    ];
    for (const [dr, dc] of dirs) {
        let count = 1;
        count += countInDirection(row, col, dr, dc, color);
        count += countInDirection(row, col, -dr, -dc, color);
        if (count >= 4) return true;
    }
    return false;
}

function countInDirection(r, c, dr, dc, color) {
    let count = 0;
    for (let i = 1; i < 4; i++) {
        const nr = r + dr * i, nc = c + dc * i;
        if (nr < 0 || nr >= 6 || nc < 0 || nc >= 7) break;
        if (board[nr][nc] === color) count++;
        else break;
    }
    return count;
}

// üß© --- Fonction pour trouver la ligne vide la plus basse ---
function getLowestEmptyRow(col) {
    for (let r = 5; r >= 0; r--) {
        if (!board[r][col]) return r;
    }
    return -1;
}

// üß© --- Mise √† jour visuelle du plateau ---
function updateBoard() {
    const cells = document.querySelectorAll(".cell");
    cells.forEach((cell, i) => {
        const row = Math.floor(i / 7);
        const col = i % 7;
        const color = board[row][col];
        cell.style.backgroundColor = color === "red" ? "red" : color === "yellow" ? "gold" : "#1e293b";
    });
}

// üß© --- Mise √† jour de la pendule ---
function updateClocks() {
    const myClock = (turn === currentColor) ? "myClock" : "opClock";
    const opClock = (turn !== currentColor) ? "myClock" : "opClock";

    clearInterval(myInterval);
    clearInterval(opInterval);

    if (turn === currentColor) {
        myInterval = setInterval(() => {
            myTime--;
            el(myClock).textContent = formatTime(myTime);
            if (myTime <= 0) endGame("Temps √©coul√© !", turn === "red" ? "yellow" : "red");
        }, 1000);
    } else {
        opInterval = setInterval(() => {
            opTime--;
            el(opClock).textContent = formatTime(opTime);
            if (opTime <= 0) endGame("Temps √©coul√© !", turn);
        }, 1000);
    }
}

function formatTime(t) {
    const m = Math.floor(t / 60);
    const s = t % 60;
    return `${m}:${s < 10 ? "0" + s : s}`;
}

// üß© --- Helpers DOM ---
function el(id) { return document.getElementById(id); }

</script>