<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puissance 4 Matchmaking</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
/* ---------- STYLES GÉNÉRAUX ---------- */
:root{
  --bg:#071128; --card:#0e2436; --muted:#9fb7c7; --text:#e8f3fb;
  --accent:#2ea44f; --accent-strong:#26a14a; --ghost:#133147; --danger:#e06a4a;
  --board-hole:#0b3a57; --hole-edge:#163a54; --disc-shadow: rgba(0,0,0,0.45);
}
*{box-sizing:border-box} html,body{height:100%;}
body{margin:0;padding:0.9rem; font-family:-apple-system, "Inter", "Segoe UI", Roboto, sans-serif;
background:linear-gradient(180deg,var(--bg) 0%,#052033 100%); color:var(--text);
display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:0.8rem; min-height:100vh;}

h1{margin:0.6rem 0 0; font-size:1.15rem; font-weight:700; color:var(--text);
letter-spacing:0.2px; text-align:center; width:100%; max-width:420px; text-shadow:0 1px 0 rgba(0,0,0,0.45); padding:8px 0;}

/* ---------- CONTENEURS ---------- */
#loginContainer, #controls, #rematchContainer, #clocks, #playerInfo{
  width:100%; max-width:420px; display:flex; flex-direction:column; gap:0.45rem; align-items:stretch;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); padding:0.7rem; border-radius:12px;
  border:1px solid rgba(255,255,255,0.04); box-shadow:0 6px 18px rgba(2,6,12,0.55), inset 0 1px 0 rgba(255,255,255,0.02);
}

input[type="text"], input[type="password"], textarea{
  width:100%; min-height:44px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); color:var(--text);
  font-size:0.95rem; outline:none; box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); resize:vertical; transition: box-shadow .12s, border-color .12s, transform .06s;
}
input::placeholder{ color: rgba(255,255,255,0.35); font-weight:500; }
input:focus{ border-color: rgba(46,164,79,0.9); box-shadow:0 6px 18px rgba(46,164,79,0.06), inset 0 1px 0 rgba(255,255,255,0.02); transform: translateY(-1px); }

button{display:inline-flex; align-items:center; justify-content:center; gap:8px; min-height:44px; padding:10px 14px; border-radius:12px; border:none; background: var(--ghost); color:var(--text); font-weight:700; font-size:0.95rem; cursor:pointer; transition: transform .08s, box-shadow .12s, background .12s; box-shadow:0 6px 14px rgba(2,6,12,0.5);}
button:hover{ transform: translateY(-2px); } button:active{ transform: translateY(0); box-shadow:0 4px 8px rgba(0,0,0,0.5); } button:disabled{opacity:0.45; cursor:not-allowed; transform:none; box-shadow:none;}

#loginContainer button, #controls button{ width:100%; }
#loginContainer button#createAccountBtn, #loginContainer button#loginBtn, #controls button#createMatch, #controls button#joinMatch{ background: linear-gradient(180deg,var(--accent),var(--accent-strong)); color:#fff; box-shadow:0 8px 22px rgba(38,161,74,0.18); }

#status,#loginStatus,#rematchStatus{color:var(--muted); font-weight:600; font-size:0.9rem; padding:6px 8px; border-radius:8px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.02); }

#playerInfo{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));}
#playerInfo>div{display:flex; flex-direction:column; gap:4px; font-size:0.95rem; color:var(--text);}
#playerInfo span{ font-weight:800; color:#fff; font-size:0.95rem; }

#clocks{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.03); font-weight:800; font-size:0.95rem; }

#board{width:100%; max-width:420px; aspect-ratio: 7 / 6; display:grid; grid-template-columns: repeat(7,1fr); grid-template-rows: repeat(6,1fr); gap:8px; padding:14px; border-radius:16px; background:linear-gradient(180deg, var(--board-hole), #082a3d); box-shadow:0 18px 40px rgba(1,8,15,0.7), inset 0 2px 10px rgba(255,255,255,0.02);}
.cell{width:100%; height:100%; aspect-ratio:1/1; border-radius:50%; display:flex; align-items:center; justify-content:center; background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.03), transparent 20%), linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); box-shadow: inset 0 -6px 12px rgba(0,0,0,0.6), inset 0 2px 6px rgba(255,255,255,0.02); cursor:pointer; position:relative; overflow:hidden; border:1px solid rgba(255,255,255,0.02);}
.disc{width:86%; height:86%; border-radius:50%; background:#111; box-shadow:0 6px 14px var(--disc-shadow), inset 0 2px 8px rgba(255,255,255,0.03); transition: transform .28s cubic-bezier(.2,.9,.3,1), background .2s ease, box-shadow .12s ease; display:block; z-index:1;}
.cell::after{content:""; position:absolute; inset:10% 10%; border-radius:50%; background: radial-gradient(circle at 35% 30%, rgba(255,255,255,0.02), rgba(0,0,0,0.3)); z-index:0; pointer-events:none;}
.disc.red{background:linear-gradient(180deg,#ff5b5b,#c43b3b); box-shadow:0 8px 18px rgba(196,59,59,0.28), inset 0 2px 8px rgba(255,255,255,0.06);}
.disc.yellow{background:linear-gradient(180deg,#ffd35b,#d6a42c); box-shadow:0 8px 18px rgba(214,164,44,0.22), inset 0 2px 8px rgba(255,255,255,0.06);}
@keyframes dropIn{from{transform:translateY(-40%) scale(.98); opacity:0.85;}to{transform:translateY(0) scale(1); opacity:1;}}
.disc.dropped{animation:dropIn .26s cubic-bezier(.2,.9,.3,1) both;}
#rematchContainer{display:flex; gap:8px; align-items:center; justify-content:center; padding:8px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));}
</style>
</head>
<body>

<h1>Puissance 4 Matchmaking</h1>

<div id="loginContainer">
  <input type="text" id="usernameInput" placeholder="Pseudo">
  <input type="password" id="passwordInput" placeholder="Mot de passe">
  <button id="createAccountBtn">Créer un compte</button>
  <button id="loginBtn">Se connecter</button>
  <div id="loginStatus"></div>
</div>

<div id="playerInfo" style="display:none;">
  <div id="myEloContainer">Elo : <span id="myElo"></span></div>
  <div id="opponentContainer" style="display:none;">
    Adversaire : <span id="opName">—</span> (<span id="opElo">—</span>)
  </div>
</div>

<div id="controls" style="display:none;">
  <button id="createMatch">Créer une partie</button>
  <button id="joinMatch">Rejoindre un match</button>
  <div id="status">Statut : Déconnecté</div>
</div>

<div id="clocks" style="display:none;">
  <div id="myClock">00:00</div>
<div id="opponentClock">00:00</div>
</div>

<div id="board" style="display:none;"></div>

<div id="rematchContainer" style="display:none;">
  <button id="requestRematch">Demander un rematch</button>
  <div id="rematchStatus"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
// ---------- INIT SUPABASE ----------
const SUPABASE_URL = "https://arqyrmvnenrtxqryihnz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycXlybXZuZW5ydHhxcnlpaG56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTE1NjUsImV4cCI6MjA3NzMyNzU2NX0.fGs08ElwvYY2JOnWmq4sveYEa2Dg7g0BsdmRrkRM4xc";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ---------- VARIABLES GLOBALES ----------
let currentUser = null;
let currentMatch = null;
let board = Array(6).fill(null).map(()=>Array(7).fill(null));
let myColor = null;
let myTurn = false;
let myTimer = 600;      // 10 minutes
let oppTimer = 600;
let timerInterval = null;

// ---------- LOGIN / ACCOUNT ----------
document.getElementById("createAccountBtn").addEventListener("click", async ()=>{
    const username = document.getElementById("usernameInput").value.trim();
    const password = document.getElementById("passwordInput").value;
    if(!username || !password){ loginStatus("Remplissez les champs"); return; }
    const { data, error } = await supabase.from("users").insert({username, password, elo:1000});
    if(error){ loginStatus("Erreur : "+error.message); return; }
    loginStatus("Compte créé ! Connectez-vous");
});

document.getElementById("loginBtn").addEventListener("click", async ()=>{
    const username = document.getElementById("usernameInput").value.trim();
    const password = document.getElementById("passwordInput").value;
    const { data, error } = await supabase.from("users").select("*").eq("username", username).eq("password", password).single();
    if(error){ loginStatus("Connexion échouée"); return; }
    currentUser = data;
    document.getElementById("loginContainer").style.display="none";
    document.getElementById("controls").style.display="flex";
    document.getElementById("playerInfo").style.display="flex";
    document.getElementById("myElo").textContent = currentUser.elo;
    updateStatus("Connecté en tant que "+currentUser.username);
});

// ---------- STATUS ----------
function loginStatus(msg){ document.getElementById("loginStatus").textContent = msg; }
function updateStatus(msg){ document.getElementById("status").textContent = "Statut : "+msg; }

// ---------- MATCHMAKING ----------
document.getElementById("createMatch").addEventListener("click", async ()=>{
    const { data, error } = await supabase.from("matches").insert({
        player1: currentUser.username,
        boardState: JSON.stringify(board),
        status: "waiting",
        p1_elo: currentUser.elo
    }).select().single();
    if(error){ updateStatus("Erreur création : "+error.message); return; }
    currentMatch = data;
    myColor = "red";
    myTurn = true;
    showBoard();
    listenMatch();
    updateStatus("En attente d'adversaire...");
});

document.getElementById("joinMatch").addEventListener("click", async ()=>{
    const { data, error } = await supabase.from("matches").select("*").eq("status","waiting").limit(1).single();
    if(error || !data){ updateStatus("Aucun match trouvé"); return; }
    await supabase.from("matches").update({
        player2: currentUser.username,
        status: "playing",
        p2_elo: currentUser.elo
    }).eq("id", data.id);
    currentMatch = {...data, player2: currentUser.username, status:"playing", p2_elo:currentUser.elo};
    myColor = "yellow";
    myTurn = false;
    showBoard();
    listenMatch();
    updateStatus("Match trouvé contre "+data.player1);
});

// ---------- AFFICHAGE PLATEAU ----------
function showBoard(){
    document.getElementById("board").style.display="grid";
    document.getElementById("clocks").style.display="flex";
    renderBoard();
}

function renderBoard(){
    const boardDiv = document.getElementById("board");
    boardDiv.innerHTML = "";
    for(let r=0;r<6;r++){
        for(let c=0;c<7;c++){
            const cell = document.createElement("div");
            cell.classList.add("cell");
            cell.dataset.row = r;
            cell.dataset.col = c;
            const disc = document.createElement("div");
            disc.classList.add("disc");
            if(board[r][c]){ disc.classList.add(board[r][c],"dropped"); }
            cell.appendChild(disc);
            cell.addEventListener("click", ()=>cellClick(c));
            boardDiv.appendChild(cell);
        }
    }
}

// ---------- CLIQUE CELLULE ----------
async function cellClick(col){
    if(!myTurn || !currentMatch) return;
    for(let r=5;r>=0;r--){
        if(!board[r][col]){
            board[r][col]=myColor;
            myTurn=false;
            await updateMatch();
            renderBoard();
            checkWin(r,col);
            return;
        }
    }
}

// ---------- UPDATE MATCH ----------
async function updateMatch(){
    await supabase.from("matches").update({
        boardState: JSON.stringify(board),
        last_move: Date.now(),
        last_player: currentUser.username
    }).eq("id", currentMatch.id);
}

// ---------- LISTEN MATCH ----------
function listenMatch(){
    supabase.from("matches").on("UPDATE", payload=>{
        const match = payload.new;
        if(!match) return;
        currentMatch = match;
        board = JSON.parse(match.boardState);
        renderBoard();
        if(match.last_player !== currentUser.username) myTurn = true;
    }).subscribe();
}

// ---------- VÉRIFICATION GAGNANT ----------
function checkWin(r,c){
    const color = board[r][c];
    if(checkDirection(r,c,1,0,color) || checkDirection(r,c,0,1,color) ||
       checkDirection(r,c,1,1,color) || checkDirection(r,c,1,-1,color)){
        updateStatus(color+" a gagné !");
        myTurn=false;
    }
}

function checkDirection(r,c,dr,dc,color){
    let count=1;
    for(let i=1;i<4;i++){ if(board[r+i*dr]?.[c+i*dc]===color) count++; else break; }
    for(let i=1;i<4;i++){ if(board[r-i*dr]?.[c-i*dc]===color) count++; else break; }
    return count>=4;
}

// ---------- REMATCH ----------
document.getElementById("requestRematch").addEventListener("click", async ()=>{
    if(!currentMatch) return;
    // Réinitialiser plateau
    board = Array(6).fill(null).map(()=>Array(7).fill(null));
    myTurn = (myColor==="red");
    renderBoard();
    updateStatus("Rematch prêt !");
});

// ---------- TIMER ----------
function startTimers(){
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
        if(myTurn) myTimer--; else oppTimer--;
        document.getElementById("myClock").textContent = formatTime(myTimer);
        document.getElementById("opponentClock").textContent = formatTime(oppTimer);
        if(myTimer<=0 || oppTimer<=0){ updateStatus("Temps écoulé !"); clearInterval(timerInterval); }
    },1000);
}

function formatTime(sec){
    const m = Math.floor(sec/60).toString().padStart(2,'0');
    const s = (sec%60).toString().padStart(2,'0');
    return `${m}:${s}`;
}

</script>
</body>
</html>